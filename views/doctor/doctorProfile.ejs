<%- layout('layout/boilerplate') %>
<link rel="stylesheet" href="/css/icon.css" />
<link rel="stylesheet" href="/css/doctorProfile.css" />

<div class="profile-outer">
  <% if (user && user.username === doctor.username) { %>
  <aside class="sidebar-menu">
    <nav class="menu-nav" aria-label="Profile navigation">
      <a
        href="/caredata/doctors/<%= doctor._id %>/profile"
        class="menu-option<%= activeTab === 'profile' ? ' active' : '' %>"
      >
        <ion-icon name="person-circle-outline"></ion-icon>Profile
      </a>
      <a
        href="/caredata/doctors/<%= doctor._id %>/files"
        class="menu-option<%= activeTab === 'files' ? ' active' : '' %>"
      >
        <ion-icon name="documents-outline"></ion-icon>Files
      </a>
      <a
        href="/caredata/doctors/<%= doctor._id %>/appointments"
        class="menu-option<%= activeTab === 'appointments' ? ' active' : '' %>"
      >
        <ion-icon name="calendar-outline"></ion-icon>Appointments
      </a>
      <a
        href="/caredata/doctors/<%= doctor._id %>/video"
        class="menu-option<%= activeTab === 'video' ? ' active' : '' %>"
      >
        <ion-icon name="videocam-outline"></ion-icon>Video
      </a>
      <a
        href="/caredata/doctors/<%= doctor._id %>/settings"
        class="menu-option<%= activeTab === 'settings' ? ' active' : '' %>"
      >
        <ion-icon name="settings-outline"></ion-icon>Settings
      </a>
    </nav>
  </aside>
  <% } %>

  <main
    class="profile-main <%= (user && user.username === doctor.username) ? 'has-sidebar' : '' %>"
  >
    <% if (activeTab === 'profile') { %>
    <section class="info-header">
      <div>
        <img
          class="profile-photo"
          src="<%= doctor.doctorDetails?.profilePhotoUrl || doctor.image?.path %>"
          alt="Dr. <%= doctor.fullName %>"
        />
      </div>

      <div class="info-header-details">
        <h1><%= doctor.fullName %></h1>
        <div class="doctor-specialty">
          <%= doctor.doctorDetails?.speciality || '-' %>
        </div>
        <div class="doctor-tags">
          <% if (doctor.doctorDetails?.subSpecialities?.length) {
          doctor.doctorDetails.subSpecialities.forEach(tag => { %>
          <span class="tag"><%= tag %></span>
          <% }) } %>
        </div>
        <div class="exp-fees">
          <span>
            <i class="fa-solid fa-hourglass-half"></i>
            <%= doctor.doctorDetails?.experience != null ?
            `${doctor.doctorDetails.experience} yrs` : '-' %>
          </span>
          <span>
            <i class="fa-solid fa-dollar-sign"></i> â‚¹ <%=
            doctor.doctorDetails?.fees != null ? doctor.doctorDetails.fees : '-'
            %>
          </span>
        </div>
      </div>
    </section>

    <section class="info-section">
      <div class="info-grid">
        <div>
          <div class="ico-label">
            <i class="fa-solid fa-user-graduate"></i> Education
          </div>
          <div class="val"><%= doctor.doctorDetails.education || '-' %></div>
        </div>
        <div>
          <div class="ico-label">
            <i class="fa-solid fa-hospital"></i> Clinic
          </div>
          <div class="val"><%= doctor.doctorDetails.clinicName || '-' %></div>
          <div class="minor">
            <i class="fa-solid fa-location-dot"></i>
            <%= doctor.doctorDetails.clinicAddress ||
            doctor.doctorDetails.location || '-' %>
          </div>
        </div>
        <div>
          <div class="ico-label"><i class="fa-solid fa-phone"></i> Contact</div>
          <div class="val">
            <%= doctor.doctorDetails.contactNumber || '-' %>
          </div>
          <div class="minor">
            <i class="fa-regular fa-envelope"></i> <%=
            doctor.doctorDetails.email || '-' %>
          </div>
        </div>
        <div>
          <div class="ico-label">
            <ion-icon name="language"></ion-icon> Languages
          </div>
          <div>
            <% (doctor.doctorDetails.language || []).forEach(lan => { %>
            <span class="chip"><%= lan %></span>
            <% }) %>
          </div>
        </div>
        <div>
          <div class="ico-label">
            <i class="fa-regular fa-id-card"></i> Reg. ID
          </div>
          <div class="val"><%= doctor.doctorDetails.regId || '-' %></div>
        </div>
        <div>
          <div class="ico-label"><i class="fa-solid fa-trophy"></i> Awards</div>
          <div>
            <% (doctor.doctorDetails.awards || []).forEach(award => { %>
            <span class="chip award"><%= award %></span>
            <% }) %>
          </div>
        </div>
        <div>
          <div class="ico-label">
            <i class="fa-solid fa-certificate"></i> Certifications
          </div>
          <div>
            <% (doctor.doctorDetails.certifications || []).forEach(cert => { %>
            <span class="chip cert"><%= cert %></span>
            <% }) %>
          </div>
        </div>
        <div>
          <div class="ico-label"><i class="fa-solid fa-list"></i> Services</div>
          <div>
            <% (doctor.doctorDetails.services || []).forEach(svc => { %>
            <span class="chip service"><%= svc %></span>
            <% }) %>
          </div>
        </div>
        <div>
          <div class="ico-label">
            <ion-icon name="people-circle"></ion-icon> Consultation
          </div>
          <div>
            <% (doctor.doctorDetails.consultationTypes || []).forEach(type => {
            %>
            <span class="chip consult"><%= type %></span>
            <% }) %>
          </div>
        </div>
        <div>
          <div class="ico-label">
            <i class="fa-regular fa-clock"></i> Clinic Timings
          </div>
          <div>
            <% (doctor.doctorDetails.clinicTimings || []).forEach(ct => { %>
            <span class="chip timing"
              ><%= ct.day %>: <%= ct.open %>-<%= ct.close %></span
            >
            <% }) %> <% if (!(doctor.doctorDetails.clinicTimings || []).length)
            { %>
            <span>-</span>
            <% } %>
          </div>
        </div>
      </div>
    </section>

    <section class="about-section">
      <h2>About Doctor</h2>
      <p>
        <%= doctor.doctorDetails.aboutDoctor || 'No biography available.' %>
      </p>
    </section>

    <section class="sociallinks-section">
      <% if (doctor.doctorDetails.socialLinks) { const s =
      doctor.doctorDetails.socialLinks; %> <% if (s.website) { %>
      <a href="<%= s.website %>" target="_blank" aria-label="Website">
        <ion-icon name="globe-outline"></ion-icon>
      </a>
      <% } %> <% if (s.linkedin) { %>
      <a href="<%= s.linkedin %>" target="_blank" aria-label="LinkedIn">
        <ion-icon name="logo-linkedin"></ion-icon>
      </a>
      <% } %> <% if (s.facebook) { %>
      <a href="<%= s.facebook %>" target="_blank" aria-label="Facebook">
        <ion-icon name="logo-facebook"></ion-icon>
      </a>
      <% } %> <% if (s.twitter) { %>
      <a href="<%= s.twitter %>" target="_blank" aria-label="Twitter">
        <ion-icon name="logo-twitter"></ion-icon>
      </a>
      <% } %> <% if (s.instagram) { %>
      <a href="<%= s.instagram %>" target="_blank" aria-label="Instagram">
        <ion-icon name="logo-instagram"></ion-icon>
      </a>
      <% } %> <% } %>
    </section>

    <% } else if (activeTab === 'files') { %>
    <section class="files-section">
      <h2>Shared Files</h2>
      <p>No files uploaded yet.</p>
    </section>

    <% } else if (activeTab === 'appointments') { %>
    <section class="appointments-section">
      <h2>Your Appointments</h2>
      <div class="appointments-grid">
        <% (doctor.appointments || []).forEach((appointment, idx) => { %>
        <div class="appointment-card">
          <div class="apt-row">
            <strong>#<%= idx + 1 %></strong>
            <span class="apt-opt">Accept | Decline</span>
          </div>
          <div class="apt-row">
            <ion-icon name="person-outline"></ion-icon> <%= appointment.name %>
          </div>
          <div class="apt-row">
            <ion-icon name="call-outline"></ion-icon> <%= appointment.phone %>
          </div>
          <div class="apt-row">
            <ion-icon name="mail-outline"></ion-icon> <%= appointment.email %>
          </div>
          <div class="apt-row">
            <ion-icon name="calendar-clear-outline"></ion-icon>
            <%= appointment.date %> at <%= appointment.timeslot %>
          </div>
        </div>
        <% }) %>
      </div>
    </section>

    <% } else if (activeTab === 'video') { %>
    <section class="video-section">
      <h2>Video Consultation</h2>
      <p>Video call feature coming soon.</p>
    </section>

    <% } else if (activeTab === 'settings') { %>
    <section class="settings-section">
      <h2>Settings</h2>
      <% if (user && user.username === doctor.username) { %>
      <div class="settings-actions">
        <a
          href="/caredata/users/<%= doctor._id %>/edit"
          class="btn btn-primary btn-lg mb-3 w-100"
        >
          <ion-icon name="create-outline"></ion-icon> Edit Profile
        </a>

        <a
          href="/caredata/doctors/<%= doctor._id %>/add"
          class="btn btn-success btn-lg mb-3 w-100"
        >
          <ion-icon name="add-circle-outline"></ion-icon> Add Details
        </a>

        <form
          action="/logout"
          method="post"
          onsubmit="return confirm('Are you sure you want to log out?');"
        >
          <button type="submit" class="btn btn-danger btn-lg w-100">
            <ion-icon name="log-out-outline"></ion-icon> Log Out
          </button>
        </form>
      </div>
      <% } else { %>
      <p>You do not have access to this section.</p>
      <% } %>
    </section>
    <% } %>
  </main>

  <% /* Patient booking sidebar: show only for logged-in users who are NOT
  doctors */ %> <% if (user && user.entryType !== 'doctor') { %>
  <aside class="booking-sidebar">
    <div class="clinic-hours">
      <h3>Clinic Hours</h3>
      <p>
        <%= doctor.doctorDetails?.clinicTimings &&
        doctor.doctorDetails.clinicTimings.length ?
        doctor.doctorDetails.clinicTimings.map(t => `${t.day}:
        ${t.open}-${t.close}`).join(', ') : "N/A" %>
      </p>
    </div>
    <div class="booking-actions">
      <a
        href="/caredata/users/<%= doctor._id %>/book-appointment"
        class="btn booking primary-btn"
        >Book Appointment</a
      >
      <button class="btn booking secondary-btn">Video Consult</button>
    </div>
  </aside>
  <% } %>
</div>
